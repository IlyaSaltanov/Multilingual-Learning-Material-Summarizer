name: CI/CD Pipeline

on:
  # Автоматический запуск при push и pull request
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ main, master ]


  # Ручной запуск с параметрами
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        required: true
        default: 'python-3.11'
        type: choice
        options:
          - python-3.9
          - python-3.10
          - python-3.11
          - python-3.12
      run_extensive_tests:
        description: 'Run extensive tests'
        required: false
        default: false
        type: boolean
      generate_report:
        description: 'Generate test report'
        required: false
        default: true
        type: boolean

  # Запуск по расписанию (каждый день в 8:00 UTC)
  schedule:
    - cron: '0 8 * * *'


# Разрешить одновременные запуски
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest


    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint

      - name: Check code formatting with Black
        run: |
          black --check src/ tests/

      - name: Lint with flake8
        run: |
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics


      - name: Lint with pylint
        run: |
          pylint --disable=all --enable=E,W src/ || true


  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: quality-check


    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}


      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m nltk.downloader punkt


      - name: Run basic tests
        run: |
          pytest tests/ -v --tb=short || echo "Tests may have failed, continuing..."


      - name: Run tests with coverage
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        run: |
          pip install pytest-cov
          pytest tests/ --cov=src --cov-report=xml --cov-report=html || true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: htmlcov/


  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"


      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m nltk.downloader punkt


      - name: Run performance tests
        run: >
          python -c '
          import sys
          sys.path.insert(0, "src")
          from summarizer import TextSummarizer
          import time

          text = \"\"\"Artificial intelligence (AI) is intelligence demonstrated by machines, as opposed to natural intelligence displayed by animals including humans. Leading AI textbooks define the field as the study of intelligent agents: any system that perceives its environment and takes actions that maximize its chance of achieving its goals.\"\"\"


          summarizer = TextSummarizer()

          # Тестируем производительность
          start = time.time()
          for _ in range(10):
              summary = summarizer.summarize_extractive(text, "en", 30)
          end = time.time()

          print(f"Time for 10 summaries: {end-start:.2f} seconds")
          print(f"Average time per summary: {(end-start)/10:.3f} seconds")
          print(f"Original length: {len(text.split())} words")
          print(f"Summary length: {len(summary.split())} words")
          print(f"Reduction: {100 - (len(summary.split()) / len(text.split()) * 100):.1f}%")
          '

      - name: Save performance metrics
        run: |
          echo "PERFORMANCE_METRICS=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          mkdir -p metrics
          echo "Last run: $(date)" > metrics/performance.txt
          echo "Branch: ${{ github.ref }}" >> metrics/performance.txt
          echo "Commit: ${{ github.sha }}" >> metrics/performance.txt

  generate-report:
    name: Generate Daily Report
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    if: ${{ github.event_name == 'schedule' || github.event_inputs.generate_report == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pandas


      - name: Generate daily statistics
        run: |
          python -c '
          import sys
          sys.path.insert(0, "src")
          import json
          import pandas as pd
          from datetime import datetime

          try:
              from summarizer import TextSummarizer
              from language_detector import LanguageDetector


              # Тестовые данные
              samples = [
                  {"text": "Artificial intelligence is transforming industries worldwide. AI applications are diverse.", "lang": "en"},
                  {"text": "Machine learning allows computers to learn from data. This is important technology.", "lang": "en"},
              ]

              summarizer = TextSummarizer()
              detector = LanguageDetector()


              results = []
              for sample in samples:
                  summary = summarizer.summarize_extractive(sample["text"], sample["lang"], 30)
                  stats = summarizer.calculate_statistics(sample["text"], summary)
                  detected = detector.detect_language(sample["text"])


                  results.append({
                      "language": sample["lang"],
                      "detected_language": detected["language"],
                      "detected_confidence": detected["confidence"],
                      "original_length": stats["original_length"],