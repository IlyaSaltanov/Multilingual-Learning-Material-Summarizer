name: CI/CD Pipeline

on:
  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð¸ pull request
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ main, master ]
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        required: true
        default: 'python-3.11'
        type: choice
        options:
        - python-3.9
        - python-3.10
        - python-3.11
        - python-3.12
      run_extensive_tests:
        description: 'Run extensive tests'
        required: false
        default: false
        type: boolean
      generate_report:
        description: 'Generate test report'
        required: false
        default: true
        type: boolean
  
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 8:00 UTC)
  schedule:
    - cron: '0 8 * * *'

# Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ¸
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint
    
    - name: Check code formatting with Black
      run: |
        black --check src/ tests/
    
    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Lint with pylint
      run: |
        pylint --disable=all --enable=E,W src/ || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: quality-check
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m nltk.downloader punkt
    
    - name: Run basic tests
      run: |
        pytest tests/ -v --tb=short || echo "Tests may have failed, continuing..."
    
    - name: Run tests with coverage
      if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
      run: |
        pip install pytest-cov
        pytest tests/ --cov=src --cov-report=xml --cov-report=html || true
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m nltk.downloader punkt
    
    - name: Run performance tests
      run: |
        python -c '
import sys
sys.path.insert(0, "src")
from summarizer import TextSummarizer
import time

text = """Artificial intelligence (AI) is intelligence demonstrated by machines, as opposed to natural intelligence displayed by animals including humans. Leading AI textbooks define the field as the study of intelligent agents: any system that perceives its environment and takes actions that maximize its chance of achieving its goals."""

summarizer = TextSummarizer()

# Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
start = time.time()
for _ in range(10):
    summary = summarizer.summarize_extractive(text, "en", 30)
end = time.time()

print(f"Time for 10 summaries: {end-start:.2f} seconds")
print(f"Average time per summary: {(end-start)/10:.3f} seconds")
print(f"Original length: {len(text.split())} words")
print(f"Summary length: {len(summary.split())} words")
print(f"Reduction: {100 - (len(summary.split()) / len(text.split()) * 100):.1f}%")
        '
    
    - name: Save performance metrics
      run: |
        echo "PERFORMANCE_METRICS=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        mkdir -p metrics
        echo "Last run: $(date)" > metrics/performance.txt
        echo "Branch: ${{ github.ref }}" >> metrics/performance.txt
        echo "Commit: ${{ github.sha }}" >> metrics/performance.txt

  generate-report:
    name: Generate Daily Report
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    if: ${{ github.event_name == 'schedule' || github.event_inputs.generate_report == 'true' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pandas
    
    - name: Generate daily statistics
      run: |
        python -c '
import sys
sys.path.insert(0, "src")
import json
import pandas as pd
from datetime import datetime

try:
    from summarizer import TextSummarizer
    from language_detector import LanguageDetector
    
    # Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
    samples = [
        {"text": "Artificial intelligence is transforming industries worldwide. AI applications are diverse.", "lang": "en"},
        {"text": "Machine learning allows computers to learn from data. This is important technology.", "lang": "en"},
    ]
    
    summarizer = TextSummarizer()
    detector = LanguageDetector()
    
    results = []
    for sample in samples:
        summary = summarizer.summarize_extractive(sample["text"], sample["lang"], 30)
        stats = summarizer.calculate_statistics(sample["text"], summary)
        detected = detector.detect_language(sample["text"])
        
        results.append({
            "language": sample["lang"],
            "detected_language": detected["language"],
            "detected_confidence": detected["confidence"],
            "original_length": stats["original_length"],
            "summary_length": stats["summary_length"],
            "reduction_percent": stats["reduction_percent"],
            "timestamp": datetime.now().isoformat()
        })
    
    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
    df = pd.DataFrame(results)
    df.to_csv("daily_report.csv", index=False)
    
    print("Daily report generated:")
    print(df.to_string())
    
    # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ README Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸
    with open("DAILY_REPORT.md", "w") as f:
        f.write("# Daily Summary Report\n\n")
        f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        f.write("## Performance Metrics\n\n")
        f.write("| Language | Detected | Confidence | Original | Summary | Reduction |\n")
        f.write("|----------|----------|------------|----------|---------|-----------|\n")
        for _, row in df.iterrows():
            f.write(f"| {row['language']} | {row['detected_language']} | {row['detected_confidence']:.2f} | ")
            f.write(f"{row['original_length']} | {row['summary_length']} | {row['reduction_percent']:.1f}% |\n")
        
        avg_reduction = df["reduction_percent"].mean()
        f.write(f"\n**Average Reduction:** {avg_reduction:.1f}%\n")
        
        total_processed = df["original_length"].sum()
        f.write(f"**Total Words Processed:** {total_processed}\n")
    
except Exception as e:
    print(f"Error generating report: {e}")
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    with open("DAILY_REPORT.md", "w") as f:
        f.write("# Daily Summary Report\n\n")
        f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        f.write("Report generation failed. Check workflow logs for details.\n")
        '
    
    - name: Commit and push report
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add daily_report.csv DAILY_REPORT.md 2>/dev/null || echo "Files not found"
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ“Š Update daily report $(date +%Y-%m-%d)"
        git push || echo "Push failed, continuing..."

    - name: Upload report artifacts
      uses: actions/upload-artifact@v4
      with:
        name: daily-report-$(date +%Y-%m-%d)
        path: |
          daily_report.csv
          DAILY_REPORT.md

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material
        pip install -r requirements.txt
    
    - name: Generate documentation
      run: |
        mkdir -p docs
        cat > docs/index.md << 'EOF'
# Multilingual Summarizer

This is an AI-powered text summarization tool supporting multiple languages.

## Features
- Summarize text in English, Russian, and German
- Auto language detection
- Configurable compression levels

## API Usage
Send POST request to `/summarize` with JSON body containing text.
EOF
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ
        cp DAILY_REPORT.md docs/daily_report.md 2>/dev/null || echo "No daily report found"
    
    - name: Configure mkdocs
      run: |
        cat > mkdocs.yml << 'EOF'
site_name: Multilingual Summarizer
site_description: AI-powered text summarization in multiple languages
site_author: GitHub Actions
repo_url: https://github.com/${{ github.repository }}

theme:
  name: material

nav:
  - Home: index.md
  - Daily Report: daily_report.md
EOF
    
    - name: Build documentation
      run: |
        mkdocs build
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        publish_branch: gh-pages

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [quality-check, test, generate-report, deploy-docs]
    if: always()
    
    steps:
    - name: Workflow status
      run: |
        echo "Workflow completed!"
        echo "Quality check: ${{ needs.quality-check.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Report: ${{ needs.generate-report.result }}"
        echo "Deploy: ${{ needs.deploy-docs.result }}"