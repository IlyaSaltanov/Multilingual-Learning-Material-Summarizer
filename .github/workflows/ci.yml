name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      run_extensive_tests:
        description: 'Run extensive tests'
        required: false
        default: false
        type: boolean
      generate_report:
        description: 'Generate test report'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 8 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m nltk.downloader punkt

      - name: Run basic tests
        run: |
          pytest tests/ -v --tb=short || echo "Tests may have failed, continuing..."

      - name: Run tests with coverage
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        run: |
          pip install pytest-cov
          pytest tests/ --cov=src --cov-report=xml --cov-report=html || true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        with:
          name: coverage-report
          path: htmlcov/

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m nltk.downloader punkt

      - name: Run performance tests
        run: >
          python -c '
          import sys
          sys.path.insert(0, "src")
          from summarizer import TextSummarizer
          import time

          text = \"\"\"Artificial intelligence (AI) is intelligence demonstrated by machines, as opposed to natural intelligence displayed by animals including humans. Leading AI textbooks define the field as the study of intelligent agents: any system that perceives its environment and takes actions that maximize its chance of achieving its goals.\"\"\"

          summarizer = TextSummarizer()

          start = time.time()
          for _ in range(10):
              summary = summarizer.summarize_extractive(text, "en", 30)
          end = time.time()

          print(f"Time for 10 summaries: {end-start:.2f} seconds")
          print(f"Average time per summary: {(end-start)/10:.3f} seconds")
          '

      - name: Save performance metrics
        run: |
          echo "PERFORMANCE_METRICS=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          mkdir -p metrics
          echo "Last run: $(date)" > metrics/performance.txt
          echo "Branch: ${{ github.ref }}" >> metrics/performance.txt
          echo "Commit: ${{ github.sha }}" >> metrics/performance.txt

  generate-report:
    name: Generate Daily Report
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'schedule' || github.event_inputs.generate_report == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pandas

      - name: Generate daily statistics
        run: |
          python -c '
          import sys
          sys.path.insert(0, "src")
          import pandas as pd
          from datetime import datetime

          from summarizer import TextSummarizer
          from language_detector import LanguageDetector

          samples = [
              {"text": "Artificial intelligence is transforming industries worldwide. AI applications are diverse.", "lang": "en"},
              {"text": "Machine learning allows computers to learn from data. This is important technology.", "lang": "en"},
          ]

          summarizer = TextSummarizer()
          detector = LanguageDetector()

          results = []
          for sample in samples:
              summary = summarizer.summarize_extractive(sample["text"], sample["lang"], 30)
              detected = detector.detect_language(sample["text"])

              results.append({
                  "language": sample["lang"],
                  "detected_language": detected["language"],
                  "original_length": len(sample["text"].split()),
                  "summary_length": len(summary.split()),
                  "timestamp": datetime.now().isoformat()
              })

          df = pd.DataFrame(results)
          df.to_csv("daily_report.csv", index=False)

          with open("DAILY_REPORT.md", "w") as f:
              f.write("# Daily Summary Report\n\n")
              f.write(f!Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
              f.write("| Language | Detected | Original | Summary |\n")
              f.write("|----------|----------|---------|---------|\n")
              for _, row in df.iterrows():
                  f.write(f"| {row['language']} | {row['detected_language']} | {row['original_length']} | {row['summary_length']} |\n")
          '

      - name: Commit and push report
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add daily_report.csv DAILY_REPORT.md 2>/dev/null || echo "Files not found"
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ“Š Update daily report $(date +%Y-%m-%d)"
          git push || echo "Push failed, continuing..."

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-$(date +%Y-%m-%d)
          path: |
            daily_report.csv
            DAILY_REPORT.md

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade