name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      run_extensive_tests:
        description: 'Run extensive tests'
        required: false
        default: false
        type: boolean
      generate_report:
        description: 'Generate test report'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 8 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint pytest

      - name: Check code formatting with Black
        run: |
          if [ -d "src" ]; then
            black --check src/ || echo "‚ö†Ô∏è Code formatting issues found (non-critical)"
          fi

      - name: Lint with flake8
        run: |
          if [ -d "src" ]; then
            # stop the build if there are Python syntax errors or undefined names
            flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
            # exit-zero treats all errors as warnings
            flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          # –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (Flask, nltk –∏ —Ç.–¥.)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # –ï—Å–ª–∏ requirements.txt –Ω–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä—É—á–Ω—É—é —Ç–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ app.py
          pip install flask nltk pandas

      - name: Run basic tests
        env:
          # –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º src –≤ PYTHONPATH, —á—Ç–æ–±—ã —Ç–µ—Å—Ç—ã –≤–∏–¥–µ–ª–∏ –∫–æ–¥
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          echo "üß™ Running tests..."
          python -m pytest tests/ -v --tb=short

      - name: Run tests with coverage
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python -m pytest tests/ --cov=src --cov-report=xml --cov-report=html

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: ${{ github.event.inputs.run_extensive_tests == 'true' || github.event_name == 'schedule' }}
        with:
          name: coverage-report
          path: htmlcov/

  generate-report:
    name: Generate Daily Report
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'schedule' || github.event.inputs.generate_report == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas

      - name: Generate daily statistics
        run: |
          python -c "
          from datetime import datetime
          import pandas as pd
          
          results = [{
              'language': 'en',
              'detected_language': 'en',
              'detected_confidence': 0.99,
              'original_length': 100,
              'summary_length': 30,
              'reduction_percent': 70.0,
              'timestamp': datetime.now().isoformat()
          }]
          
          df = pd.DataFrame(results)
          df.to_csv('daily_report.csv', index=False)
          
          with open('DAILY_REPORT.md', 'w') as f:
              f.write('# üìà Daily Summary Report\n\n')
              f.write(f'Generated: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\n\n')
              f.write('## üìã Sample Metrics\n\n')
              f.write('| Language | Detected | Confidence | Original | Summary | Reduction |\n')
              f.write('|----------|----------|------------|----------|---------|-----------|\n')
              for _, row in df.iterrows():
                  f.write(f'| {row[\"language\"]} | {row[\"detected_language\"]} | {row[\"detected_confidence\"]:.2f} | ')
                  f.write(f'{row[\"original_length\"]} | {row[\"summary_length\"]} | {row[\"reduction_percent\"]:.1f}% |\n')
              
              f.write(f'\n**üìä Summary:**\n')
              f.write(f'- CI/CD pipeline is working\n')
          "

      - name: Commit and push report
        # –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –∏ –≤–µ—Ç–∫–∞ –Ω–µ –∑–∞—â–∏—â–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏ (branch protection rules)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add daily_report.csv DAILY_REPORT.md
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìä Update daily report $(date +%Y-%m-%d)"
            git push
          fi

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install mkdocs mkdocs-material

      - name: Generate documentation content
        run: |
          mkdir -p docs
          echo "site_name: Multilingual Summarizer" > mkdocs.yml
          echo "theme:" >> mkdocs.yml
          echo "  name: material" >> mkdocs.yml
          
          echo "# Multilingual Summarizer" > docs/index.md
          echo "AI-powered text summarization tool." >> docs/index.md

      - name: Build and Deploy
        run: |
          mkdocs build
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-check, test, generate-report, deploy-docs]
    steps:
      - name: Workflow status summary
        run: |
          echo "üöÄ CI/CD Pipeline Status Summary"
          echo "Tests: ${{ needs.test.result }}"
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "‚úÖ Pipeline successful."
          else
            echo "‚ö†Ô∏è Pipeline failed."
          fi